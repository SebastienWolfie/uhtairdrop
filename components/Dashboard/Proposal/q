<template>
  <div class="body">
    <DashboardHeader class="md:mx-[10%] mx-[2%] sticky top-[10px] z-50" />

    <div class="container">
      <!-- STAKING (TOP) -->
      <header class="section-header">
        <div class="uht-mark">
          <img src="/images/uht-jar.jpg" alt="Stake Logo"
               onerror="this.src='https://dummyimage.com/96x96/6a44ff/ffffff&text=UHT'"/>
          <div>
            <div class="brand-title">Stake UHT</div>
            <span class="badge"><small>Stake Your Tokens ‚Ä¢ Earn Hash Rate</small></span>
          </div>
        </div>

        <!-- INFO ICON + TOOLTIP (ADDED) -->
        <div class="info-wrapper" @mouseenter="showStakeInfo = true" @mouseleave="showStakeInfo = false">
          <button class="info-btn" aria-label="Staking help">?</button>
          <div v-if="showStakeInfo" class="info-tooltip">
            <strong>Quick guide</strong>
            <div style="margin-top:6px; font-size:13px;">
              Flexible stakes are temporarily locked for <strong>24 hours</strong> after staking.
              Locked stakes remain locked for <strong>30 days</strong>. Withdraw becomes available after the unlock time.
            </div>
          </div>
        </div>
      </header>

      <section v-if="!stakingEnabled" class="coming-soon">üöÄ Staking Coming Soon ‚Äî Stay Tuned!</section>

      <template v-else>
        <section v-if="user.isLocked" class="locked-alert">
          ‚ö†Ô∏è Your account has been locked due to rule violation.
        </section>

        <div class="staking-tabs">
          <button :class="['tab-btn', {active: activeTab === 'flexible'}]" @click="activeTab = 'flexible'">
            Flexible (24 hours)
          </button>
          <button :class="['tab-btn', {active: activeTab === 'locked'}]" @click="activeTab = 'locked'">
            Locked (30 Days)
          </button>
        </div>

        <!-- INLINE EXPLANATION (ADDED) -->
        <div class="inline-explain" style="margin-bottom:12px; color:rgba(255,255,255,0.85); font-size:13px;">
          <strong>Note:</strong>
          Flexible stakes will be labeled "Flexible" but will be withdrawable only after <strong>24 hours</strong>.
          Locked stakes are withdrawable after <strong>30 days</strong>.
        </div>

        <p v-if="error" class="text-red-400 font-semibold my-2">{{ error }}</p>

        <section class="stake-card">
          <div class="stake-info">
            <p>Balance: <strong>{{ user.balance }} UHT</strong></p>
            <p>Staked (flexible): <strong>{{ user.flexibleStaked }} UHT</strong></p>
            <p>Staked (locked): <strong>{{ user.lockedStaked }} UHT</strong></p>
          </div>

          <div class="stake-action">
            <input
              type="number"
              v-model.number="stakeAmount"
              :max="user.balance"
              placeholder="Enter UHT to stake"
              class="stake-input"
            />
            <button class="stake-btn" @click="stake" :disabled="stakeAmount <= 0 || stakeAmount > user.balance">
              {{ stakeLoading ? 'Staking...' : (stakeAmount > 0) ? 'Stake' : 'Enter Amount' }}
            </button>
          </div>

          <div class="stakes-list">
            <div
              v-for="(s, idx) in stakes"
              :key="idx"
              class="stake-item"
              :class="{ 'hovered': hoveredStake === idx }"
              @mouseenter="hoveredStake = idx"
              @mouseleave="hoveredStake = -1"
            >
              <div>
                <span class="stake-type">{{ s.type.toUpperCase() }}</span>
                <span class="stake-amount">: {{ s.amount }} UHT</span>

                <!-- SHOW UNLOCK DATE FOR BOTH TYPES (MODIFIED) -->
                <span v-if="s.unlockDate" class="stake-unlock">
                  ‚Ä¢ Unlocks: {{ s.unlockDate }}
                </span>

                <!-- SHOW COUNTDOWN IF NOT READY (ADDED) -->
                <div v-if="!s.unlockReady" class="unlock-countdown" style="margin-top:6px; font-size:13px; color:#ffd1d1;">
                  ‚è≥ Unlocks in: {{ remainingForIndex(idx) }}
                </div>
              </div>
              <div class="stake-actions">
                <button
                  class="unstake-btn"
                  @click="requestWithdraw(idx)"
                  :disabled="withdrawLoading === idx || !stakes[idx]?.unlockReady"
                >
                  {{ withdrawLoading === idx ? 'Loading...' : (stakes[idx]?.unlockReady ? 'Withdraw' : 'Locked') }}
                </button>
              </div>
            </div>
          </div>

          <div class="hashrate-bar" aria-hidden>
            <div class="progress" :style="{ width: `${hashRatePercent}%` }"></div>
          </div>
        </section>
      </template>

      <!-- VOTING (BOTTOM) -->
      <header class="section-header mt-12">
        <div class="uht-mark">
          <img src="/images/uht-jar.jpg" alt="UHT Logo" />
          <div>
            <div class="brand-title">Vote for the UHT mascot</div>
            <span class="badge"><small>Community Voting</small></span>
          </div>
        </div>
      </header>

      <div class="meta-row">
        <p>Total Votes: {{ totalVotes.toLocaleString() }}</p>
        <!-- <p>UHT Balance: {{ auth.uhtbalance.toFixed(2) }} UHT</p> -->
        <p>Voting Power: {{ userStake.amount }} UHT ({{ userStake.type || 'none' }})</p>

        <p v-if="now < VOTE_START_DATE">Voting starts in: {{ formatTime(VOTE_START_DATE - now) }}</p>
        <p v-else-if="!votingEnded">Voting ends in: {{ formatTime(VOTE_END_DATE - now) }}</p>
        <p v-else class="ended">Voting has ended</p>
      </div>

      <!-- FLAT LIST (no cards) -->
      <div class="nft-list">
        <div
          v-for="nft in nfts"
          :key="nft.id"
          class="nft-row"
          :class="{ voted: userVotedNft === nft.id }"
          @mouseenter="hoveredNft = nft.id"
          @mouseleave="hoveredNft = null"
        >
          <div class="row-left">
            <img :src="nft.img" class="nft-thumb" />
            <div class="nft-meta">
              <div class="nft-name">
                {{ nft.name }}
                <span v-if="userVotedNft === nft.id" class="you-voted-badge">You Voted</span>
              </div>
              <div class="nft-votes">{{ nft.votes.toLocaleString() }} votes ‚Ä¢ {{ displayPercent(nft) }}</div>
              <div class="progress-bar small">
                <div class="fill" :style="{ width: nft.percent + '%' }"></div>
              </div>
            </div>
          </div>

          <div class="row-right">
            <div class="supply">{{ nft.available }} left</div>
            <button
              class="vote-btn"
              @click="voteForNft(nft.id)"
              :disabled="!canVote || hasVoted || votingEnded"
            >
              {{ buttonLabel(nft.id) }}
            </button>
          </div>
        </div>
      </div>

      <footer class="page-footer">
        ¬© 2025 UHT ‚Ä¢ Universal Health Token ‚Äî Stake & Vote Together.
      </footer>
    </div>

    <!-- WITHDRAW CONFIRM MODAL -->
    <div v-if="showConfirmWithdraw" class="modal-backdrop" @click.self="closeWithdrawModal">
      <div class="modal">
        <h3>Confirm withdrawal</h3>
        <p>
          You're about to withdraw <strong>{{ confirmWithdrawAmount }} UHT</strong>
          from a <strong>{{ confirmWithdrawType }}</strong> stake.
        </p>
        <p v-if="!confirmUnlockReady" class="warning">
          This stake is not yet unlocked. Withdrawal will fail until the unlock date.
        </p>
        <p v-else class="text-green-300">This stake is unlocked ‚Äî you may proceed.</p>
        <div class="modal-actions">
          <button class="modal-cancel" @click="closeWithdrawModal">Cancel</button>
          <button class="modal-confirm" @click="withdrawStakeConfirmed" :disabled="withdrawLoading === confirmWithdrawIndex">
            {{ withdrawLoading === confirmWithdrawIndex ? 'Withdrawing...' : 'Confirm Withdraw' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</template>